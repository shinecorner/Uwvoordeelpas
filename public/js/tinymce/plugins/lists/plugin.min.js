tinymce.PluginManager.add("lists",function(e){function t(t){return e.$.contains(e.getBody(),t)}function n(e){return e&&"BR"==e.nodeName}function r(e){return e&&/^(OL|UL|DL)$/.test(e.nodeName)&&t(e)}function o(e){return e.parentNode.firstChild==e}function i(e){return e.parentNode.lastChild==e}function a(t){return t&&!!e.schema.getTextBlockElements()[t.nodeName]}function d(t){return t===e.getBody()}var s=this;e.on("init",function(){function f(e,t){var n=B.isEmpty(e);return t&&B.select("span[data-mce-type=bookmark]").length>0?!1:n}function l(e){function t(t){var r,o,i;o=e[t?"startContainer":"endContainer"],i=e[t?"startOffset":"endOffset"],1==o.nodeType&&(r=B.create("span",{"data-mce-type":"bookmark"}),o.hasChildNodes()?(i=Math.min(i,o.childNodes.length-1),t?o.insertBefore(r,o.childNodes[i]):B.insertAfter(r,o.childNodes[i])):o.appendChild(r),o=r,i=0),n[t?"startContainer":"endContainer"]=o,n[t?"startOffset":"endOffset"]=i}var n={};return t(!0),e.collapsed||t(),n}function c(e){function t(t){function n(e){for(var t=e.parentNode.firstChild,n=0;t;){if(t==e)return n;1==t.nodeType&&"bookmark"==t.getAttribute("data-mce-type")||n++,t=t.nextSibling}return-1}var r,o,i;r=i=e[t?"startContainer":"endContainer"],o=e[t?"startOffset":"endOffset"],r&&(1==r.nodeType&&(o=n(r),r=r.parentNode,B.remove(i)),e[t?"startContainer":"endContainer"]=r,e[t?"startOffset":"endOffset"]=o)}t(!0),t();var n=B.createRng();n.setStart(e.startContainer,e.startOffset),e.endContainer&&n.setEnd(e.endContainer,e.endOffset),I.setRng(n)}function m(t,n){var r,o,i,a=B.createFragment(),d=e.schema.getBlockElements();if(e.settings.forced_root_block&&(n=n||e.settings.forced_root_block),n&&(o=B.create(n),o.tagName===e.settings.forced_root_block&&B.setAttribs(o,e.settings.forced_root_block_attrs),a.appendChild(o)),t)for(;r=t.firstChild;){var s=r.nodeName;i||"SPAN"==s&&"bookmark"==r.getAttribute("data-mce-type")||(i=!0),d[s]?(a.appendChild(r),o=null):n?(o||(o=B.create(n),a.appendChild(o)),o.appendChild(r)):a.appendChild(r)}return e.settings.forced_root_block?i||tinymce.Env.ie&&!(tinymce.Env.ie>10)||o.appendChild(B.create("br",{"data-mce-bogus":"1"})):a.appendChild(B.create("br")),a}function u(){return tinymce.grep(I.getSelectedBlocks(),function(e){return/^(LI|DT|DD)$/.test(e.nodeName)})}function p(e,t,n){function r(e){tinymce.each(a,function(n){e.parentNode.insertBefore(n,t.parentNode)}),B.remove(e)}var o,i,a,d;for(a=B.select('span[data-mce-type="bookmark"]',e),n=n||m(t),o=B.createRng(),o.setStartAfter(t),o.setEndAfter(e),i=o.extractContents(),d=i.firstChild;d;d=d.firstChild)if("LI"==d.nodeName&&B.isEmpty(d)){B.remove(d);break}B.isEmpty(i)||B.insertAfter(i,e),B.insertAfter(n,e),f(t.parentNode)&&r(t.parentNode),B.remove(t),f(e)&&B.remove(e)}function h(e){var t,n;if(t=e.nextSibling,t&&r(t)&&t.nodeName==e.nodeName){for(;n=t.firstChild;)e.appendChild(n);B.remove(t)}if(t=e.previousSibling,t&&r(t)&&t.nodeName==e.nodeName){for(;n=t.firstChild;)e.insertBefore(n,e.firstChild);B.remove(t)}}function g(e){tinymce.each(tinymce.grep(B.select("ol,ul",e)),function(e){var t,n=e.parentNode;"LI"==n.nodeName&&n.firstChild==e&&(t=n.previousSibling,t&&"LI"==t.nodeName&&(t.appendChild(e),f(n)&&B.remove(n))),r(n)&&(t=n.previousSibling,t&&"LI"==t.nodeName&&t.appendChild(e))})}function v(e){function t(e){f(e)&&B.remove(e)}var n,a=e.parentNode,s=a.parentNode;return d(a)?!0:"DD"==e.nodeName?(B.rename(e,"DT"),!0):o(e)&&i(e)?("LI"==s.nodeName?(B.insertAfter(e,s),t(s),B.remove(a)):r(s)?B.remove(a,!0):(s.insertBefore(m(e),a),B.remove(a)),!0):o(e)?("LI"==s.nodeName?(B.insertAfter(e,s),e.appendChild(a),t(s)):r(s)?s.insertBefore(e,a):(s.insertBefore(m(e),a),B.remove(e)),!0):i(e)?("LI"==s.nodeName?B.insertAfter(e,s):r(s)?B.insertAfter(e,a):(B.insertAfter(m(e),a),B.remove(e)),!0):("LI"==s.nodeName?(a=s,n=m(e,"LI")):n=r(s)?m(e,"LI"):m(e),p(a,e,n),g(a.parentNode),!0)}function C(e){function t(t,n){var o;if(r(t)){for(;o=e.lastChild.firstChild;)n.appendChild(o);B.remove(t)}}var n,o;return"DT"==e.nodeName?(B.rename(e,"DD"),!0):(n=e.previousSibling,n&&r(n)?(n.appendChild(e),!0):n&&"LI"==n.nodeName&&r(n.lastChild)?(n.lastChild.appendChild(e),t(e.lastChild,n.lastChild),!0):(n=e.nextSibling,n&&r(n)?(n.insertBefore(e,n.firstChild),!0):(n=e.previousSibling,n&&"LI"==n.nodeName?(o=B.create(e.parentNode.nodeName),n.appendChild(o),o.appendChild(e),t(e.lastChild,o),!0):!1)))}function N(){var t=u();if(t.length){for(var n=l(I.getRng(!0)),r=0;r<t.length&&(C(t[r])||0!==r);r++);return c(n),e.nodeChanged(),!0}}function y(){var t=u();if(t.length){var n,r,o=l(I.getRng(!0)),i=e.getBody();for(n=t.length;n--;)for(var a=t[n].parentNode;a&&a!=i;){for(r=t.length;r--;)if(t[r]===a){t.splice(n,1);break}a=a.parentNode}for(n=0;n<t.length&&(v(t[n])||0!==n);n++);return c(o),e.nodeChanged(),!0}}function L(t){function o(){function t(e){var t,n;for(t=d[e?"startContainer":"endContainer"],n=d[e?"startOffset":"endOffset"],1==t.nodeType&&(t=t.childNodes[Math.min(n,t.childNodes.length-1)]||t);t.parentNode!=i;){if(a(t))return t;if(/^(TD|TH)$/.test(t.parentNode.nodeName))return t;t=t.parentNode}return t}for(var r,o=[],i=e.getBody(),s=t(!0),f=t(),l=[],c=s;c&&(l.push(c),c!=f);c=c.nextSibling);return tinymce.each(l,function(e){if(a(e))return o.push(e),void(r=null);if(B.isBlock(e)||n(e))return n(e)&&B.remove(e),void(r=null);var t=e.nextSibling;return tinymce.dom.BookmarkManager.isBookmarkNode(e)&&(a(t)||!t&&e.parentNode==i)?void(r=null):(r||(r=B.create("p"),e.parentNode.insertBefore(r,e),o.push(r)),void r.appendChild(e))}),o}var i,d=I.getRng(!0),s="LI";"false"!==B.getContentEditable(I.getNode())&&(t=t.toUpperCase(),"DL"==t&&(s="DT"),i=l(d),tinymce.each(o(),function(e){var n,o;o=e.previousSibling,o&&r(o)&&o.nodeName==t?(n=o,e=B.rename(e,s),o.appendChild(e)):(n=B.create(t),e.parentNode.insertBefore(n,e),n.appendChild(e),e=B.rename(e,s)),h(n)}),c(i))}function b(){var t=l(I.getRng(!0)),n=e.getBody();tinymce.each(u(),function(e){var t,o;if(!d(e.parentNode)){if(f(e))return void v(e);for(t=e;t&&t!=n;t=t.parentNode)r(t)&&(o=t);p(o,e)}}),c(t)}function k(e){var t=B.getParent(I.getStart(),"OL,UL,DL");if(!d(t))if(t)if(t.nodeName==e)b(e);else{var n=l(I.getRng(!0));h(B.rename(t,e)),c(n)}else L(e)}function D(t){return function(){var n=B.getParent(e.selection.getStart(),"UL,OL,DL");return n&&n.nodeName==t}}function S(e){return n(e)?!(!B.isBlock(e.nextSibling)||n(e.previousSibling)):!1}var B=e.dom,I=e.selection;s.backspaceDelete=function(o){function i(t,n){var r,o,i=t.startContainer,a=t.startOffset;if(3==i.nodeType&&(n?a<i.data.length:a>0))return i;for(r=e.schema.getNonEmptyElements(),1==i.nodeType&&(i=tinymce.dom.RangeUtils.getNode(i,a)),o=new tinymce.dom.TreeWalker(i,e.getBody()),n&&S(i)&&o.next();i=o[n?"next":"prev2"]();){if("LI"==i.nodeName&&!i.hasChildNodes())return i;if(r[i.nodeName])return i;if(3==i.nodeType&&i.data.length>0)return i}}function a(e,o){var i,a,s=e.parentNode;if(t(e)&&t(o)){if(r(o.lastChild)&&(a=o.lastChild),s==o.lastChild&&n(s.previousSibling)&&B.remove(s.previousSibling),i=o.lastChild,i&&n(i)&&e.hasChildNodes()&&B.remove(i),f(o,!0)&&B.$(o).empty(),!f(e,!0))for(;i=e.firstChild;)o.appendChild(i);a&&o.appendChild(a),B.remove(e),f(s)&&!d(s)&&B.remove(s)}}if(I.isCollapsed()){var s,m,u,p=B.getParent(I.getStart(),"LI");if(p){if(s=p.parentNode,d(s)&&B.isEmpty(s))return!0;if(m=I.getRng(!0),u=B.getParent(i(m,o),"LI"),u&&u!=p){var h=l(m);return o?a(u,p):a(p,u),c(h),!0}if(!u&&!o&&b(s.nodeName))return!0}}},e.on("BeforeExecCommand",function(t){var n,r=t.command.toLowerCase();return"indent"==r?N()&&(n=!0):"outdent"==r&&y()&&(n=!0),n?(e.fire("ExecCommand",{command:t.command}),t.preventDefault(),!0):void 0}),e.addCommand("InsertUnorderedList",function(){k("UL")}),e.addCommand("InsertOrderedList",function(){k("OL")}),e.addCommand("InsertDefinitionList",function(){k("DL")}),e.addQueryStateHandler("InsertUnorderedList",D("UL")),e.addQueryStateHandler("InsertOrderedList",D("OL")),e.addQueryStateHandler("InsertDefinitionList",D("DL")),e.on("keydown",function(t){9!=t.keyCode||tinymce.util.VK.metaKeyPressed(t)||e.dom.getParent(e.selection.getStart(),"LI,DT,DD")&&(t.preventDefault(),t.shiftKey?y():N())})}),e.addButton("indent",{icon:"indent",title:"Increase indent",cmd:"Indent",onPostRender:function(){var t=this;e.on("nodechange",function(){for(var n=e.selection.getSelectedBlocks(),r=!1,i=0,a=n.length;!r&&a>i;i++){var d=n[i].nodeName;r="LI"==d&&o(n[i])||"UL"==d||"OL"==d||"DD"==d}t.disabled(r)})}}),e.on("keydown",function(e){e.keyCode==tinymce.util.VK.BACKSPACE?s.backspaceDelete()&&e.preventDefault():e.keyCode==tinymce.util.VK.DELETE&&s.backspaceDelete(!0)&&e.preventDefault()})});