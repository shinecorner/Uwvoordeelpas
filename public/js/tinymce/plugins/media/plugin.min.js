tinymce.PluginManager.add("media",function(e,t){function i(e){return e=e.toLowerCase(),-1!=e.indexOf(".mp3")?"audio/mpeg":-1!=e.indexOf(".wav")?"audio/wav":-1!=e.indexOf(".mp4")?"video/mp4":-1!=e.indexOf(".webm")?"video/webm":-1!=e.indexOf(".ogg")?"video/ogg":-1!=e.indexOf(".swf")?"application/x-shockwave-flash":""}function a(t){var i=e.settings.media_scripts;if(i)for(var a=0;a<i.length;a++)if(-1!==t.indexOf(i[a].filter))return i[a]}function r(){function t(e){var t,i,o,c;t=a.find("#width")[0],i=a.find("#height")[0],o=t.value(),c=i.value(),a.find("#constrain")[0].checked()&&r&&l&&o&&c&&(e.control==t?(c=Math.round(o/r*c),isNaN(c)||i.value(c)):(o=Math.round(c/l*o),isNaN(o)||t.value(o))),r=o,l=c}function i(){m=n(this.value()),this.parent().parent().fromJSON(m)}var a,r,l,m,d=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(e){tinymce.each(e.meta,function(e,t){a.find("#"+t).value(e)})}}];e.settings.media_alt_source!==!1&&d.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),e.settings.media_poster!==!1&&d.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),e.settings.media_dimensions!==!1&&d.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:t,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:t,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),m=s(e.selection.getNode()),r=m.width,l=m.height;var u={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:o(),multiline:!0,label:"Source"};u[f]=i,a=e.windowManager.open({title:"Insert/edit video",data:m,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){m=n(this.next().find("#embed").value()),this.fromJSON(m)},items:d},{title:"Embed",type:"container",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(c(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},u]}],onSubmit:function(){var t,i,a,r;for(t=e.dom.select("img[data-mce-object]"),e.insertContent(c(this.toJSON())),i=e.dom.select("img[data-mce-object]"),a=0;a<t.length;a++)for(r=i.length-1;r>=0;r--)t[a]==i[r]&&i.splice(r,1);e.selection.select(i[0]),e.nodeChanged()}})}function o(){var t=e.selection.getNode();return t.getAttribute("data-mce-object")?e.selection.getContent():void 0}function c(r){var o="";if(!r.source1&&(tinymce.extend(r,n(r.embed)),!r.source1))return"";if(r.source2||(r.source2=""),r.poster||(r.poster=""),r.source1=e.convertURL(r.source1,"source"),r.source2=e.convertURL(r.source2,"source"),r.source1mime=i(r.source1),r.source2mime=i(r.source2),r.poster=e.convertURL(r.poster,"poster"),r.flashPlayerUrl=e.convertURL(t+"/moxieplayer.swf","movie"),tinymce.each(p,function(e){var t,i,a;if(t=e.regex.exec(r.source1)){for(a=e.url,i=0;t[i];i++)a=a.replace("$"+i,function(){return t[i]});r.source1=a,r.type=e.type,r.allowFullscreen=e.allowFullscreen,r.width=r.width||e.w,r.height=r.height||e.h}}),r.embed)o=m(r.embed,r,!0);else{var c=a(r.source1);if(c&&(r.type="script",r.width=c.width,r.height=c.height),r.width=r.width||300,r.height=r.height||150,tinymce.each(r,function(t,i){r[i]=e.dom.encode(t)}),"iframe"==r.type){var s=r.allowFullscreen?' allowFullscreen="1"':"";o+='<iframe src="'+r.source1+'" width="'+r.width+'" height="'+r.height+'"'+s+"></iframe>"}else"application/x-shockwave-flash"==r.source1mime?(o+='<object data="'+r.source1+'" width="'+r.width+'" height="'+r.height+'" type="application/x-shockwave-flash">',r.poster&&(o+='<img src="'+r.poster+'" width="'+r.width+'" height="'+r.height+'" />'),o+="</object>"):-1!=r.source1mime.indexOf("audio")?e.settings.audio_template_callback?o=e.settings.audio_template_callback(r):o+='<audio controls="controls" src="'+r.source1+'">'+(r.source2?'\n<source src="'+r.source2+'"'+(r.source2mime?' type="'+r.source2mime+'"':"")+" />\n":"")+"</audio>":"script"==r.type?o+='<script src="'+r.source1+'"></script>':o=e.settings.video_template_callback?e.settings.video_template_callback(r):'<video width="'+r.width+'" height="'+r.height+'"'+(r.poster?' poster="'+r.poster+'"':"")+' controls="controls">\n<source src="'+r.source1+'"'+(r.source1mime?' type="'+r.source1mime+'"':"")+" />\n"+(r.source2?'<source src="'+r.source2+'"'+(r.source2mime?' type="'+r.source2mime+'"':"")+" />\n":"")+"</video>"}return o}function n(e){var t={};return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(e,i){if(t.source1||"param"!=e||(t.source1=i.map.movie),"iframe"!=e&&"object"!=e&&"embed"!=e&&"video"!=e&&"audio"!=e||(t.type||(t.type=e),t=tinymce.extend(i.map,t)),"script"==e){var r=a(i.map.src);if(!r)return;t={type:"script",source1:i.map.src,width:r.width,height:r.height}}"source"==e&&(t.source1?t.source2||(t.source2=i.map.src):t.source1=i.map.src),"img"!=e||t.poster||(t.poster=i.map.src)}}).parse(e),t.source1=t.source1||t.src||t.data,t.source2=t.source2||"",t.poster=t.poster||"",t}function s(t){return t.getAttribute("data-mce-object")?n(e.serializer.serialize(t,{selection:!0})):{}}function l(t){if(e.settings.media_filter_html===!1)return t;var i,a=new tinymce.html.Writer;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(e){a.comment(e)},cdata:function(e){a.cdata(e)},text:function(e,t){a.text(e,t)},start:function(t,r,o){if(i=!0,"script"!=t&&"noscript"!=t){for(var c=0;c<r.length;c++){if(0===r[c].name.indexOf("on"))return;"style"==r[c].name&&(r[c].value=e.dom.serializeStyle(e.dom.parseStyle(r[c].value),t))}a.start(t,r,o),i=!1}},end:function(e){i||a.end(e)}},new tinymce.html.Schema({})).parse(t),a.getContent()}function m(e,t,i){function a(e,t){var i,a,r,o;for(i in t)if(r=""+t[i],e.map[i])for(a=e.length;a--;)o=e[a],o.name==i&&(r?(e.map[i]=r,o.value=r):(delete e.map[i],e.splice(a,1)));else r&&(e.push({name:i,value:r}),e.map[i]=r)}var r,o=new tinymce.html.Writer,c=0;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(e){o.comment(e)},cdata:function(e){o.cdata(e)},text:function(e,t){o.text(e,t)},start:function(e,n,s){switch(e){case"video":case"object":case"embed":case"img":case"iframe":a(n,{width:t.width,height:t.height})}if(i)switch(e){case"video":a(n,{poster:t.poster,src:""}),t.source2&&a(n,{src:""});break;case"iframe":a(n,{src:t.source1});break;case"source":if(c++,2>=c&&(a(n,{src:t["source"+c],type:t["source"+c+"mime"]}),!t["source"+c]))return;break;case"img":if(!t.poster)return;r=!0}o.start(e,n,s)},end:function(e){if("video"==e&&i)for(var n=1;2>=n;n++)if(t["source"+n]){var s=[];s.map={},n>c&&(a(s,{src:t["source"+n],type:t["source"+n+"mime"]}),o.start("source",s,!0))}if(t.poster&&"object"==e&&i&&!r){var l=[];l.map={},a(l,{src:t.poster,width:t.width,height:t.height}),o.start("img",l,!0)}o.end(e)}},new tinymce.html.Schema({})).parse(e),o.getContent()}function d(t,i){var a,r,o,c,n;for(o=t.attributes,c=o.length;c--;)a=o[c].name,r=o[c].value,"width"!==a&&"height"!==a&&"style"!==a&&("data"!=a&&"src"!=a||(r=e.convertURL(r,a)),i.attr("data-mce-p-"+a,r));n=t.firstChild&&t.firstChild.value,n&&(i.attr("data-mce-html",escape(n)),i.firstChild=null)}function u(e){var t,i=e.name;return t=new tinymce.html.Node("img",1),t.shortEnded=!0,d(e,t),t.attr({width:e.attr("width")||"300",height:e.attr("height")||("audio"==i?"30":"150"),style:e.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":i,"class":"mce-object mce-object-"+i}),t}function h(e){var t,i,a,r=e.name;return t=new tinymce.html.Node("span",1),t.attr({contentEditable:"false",style:e.attr("style"),"data-mce-object":r,"class":"mce-preview-object mce-object-"+r}),d(e,t),i=new tinymce.html.Node(r,1),i.attr({src:e.attr("src"),allowfullscreen:e.attr("allowfullscreen"),width:e.attr("width")||"300",height:e.attr("height")||("audio"==r?"30":"150"),frameborder:"0"}),a=new tinymce.html.Node("span",1),a.attr("class","mce-shim"),t.append(i),t.append(a),t}var p=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$2",allowFullscreen:!0},{regex:/youtube.com\/embed\/([a-z0-9\-_]+(?:\?.+)?)/i,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowfullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0",allowfullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1},{regex:/dailymotion\.com\/video\/([^_]+)/,type:"iframe",w:480,h:270,url:"//www.dailymotion.com/embed/video/$1",allowFullscreen:!0}],f=tinymce.Env.ie&&tinymce.Env.ie<=8?"onChange":"onInput";e.on("ResolveName",function(e){var t;1==e.target.nodeType&&(t=e.target.getAttribute("data-mce-object"))&&(e.name=t)}),e.on("preInit",function(){var t=e.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(e){t[e]=new RegExp("</"+e+"[^>]*>","gi")});var i=e.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(e){i[e]={}}),e.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(t){for(var i,r,o,c=t.length;c--;)i=t[c],i.parent&&(i.parent.attr("data-mce-object")||("script"!=i.name||(o=a(i.attr("src"))))&&(o&&(o.width&&i.attr("width",o.width.toString()),o.height&&i.attr("height",o.height.toString())),r="iframe"==i.name&&e.settings.media_live_embeds!==!1&&tinymce.Env.ceFalse?h(i):u(i),i.replace(r)))}),e.serializer.addAttributeFilter("data-mce-object",function(e,t){for(var i,a,r,o,c,n,s,m,d=e.length;d--;)if(i=e[d],i.parent){for(s=i.attr(t),a=new tinymce.html.Node(s,1),"audio"!=s&&"script"!=s&&(m=i.attr("class"),m&&-1!==m.indexOf("mce-preview-object")?a.attr({width:i.firstChild.attr("width"),height:i.firstChild.attr("height")}):a.attr({width:i.attr("width"),height:i.attr("height")})),a.attr({style:i.attr("style")}),o=i.attributes,r=o.length;r--;){var u=o[r].name;0===u.indexOf("data-mce-p-")&&a.attr(u.substr(11),o[r].value)}"script"==s&&a.attr("type","text/javascript"),c=i.attr("data-mce-html"),c&&(n=new tinymce.html.Node("#text",3),n.raw=!0,n.value=l(unescape(c)),a.append(n)),i.replace(a)}})}),e.on("click keyup",function(){var t=e.selection.getNode();t&&e.dom.hasClass(t,"mce-preview-object")&&e.dom.getAttrib(t,"data-mce-selected")&&t.setAttribute("data-mce-selected","2")}),e.on("ObjectSelected",function(e){var t=e.target.getAttribute("data-mce-object");"audio"!=t&&"script"!=t||e.preventDefault()}),e.on("objectResized",function(e){var t,i=e.target;i.getAttribute("data-mce-object")&&(t=i.getAttribute("data-mce-html"),t&&(t=unescape(t),i.setAttribute("data-mce-html",escape(m(t,{width:e.width,height:e.height})))))}),e.addButton("media",{tooltip:"Insert/edit video",onclick:r,stateSelector:["img[data-mce-object]","span[data-mce-object]"]}),e.addMenuItem("media",{icon:"media",text:"Insert/edit video",onclick:r,context:"insert",prependToContext:!0}),e.on("setContent",function(){e.$("span.mce-preview-object").each(function(t,i){var a=e.$(i);0===a.find("span.mce-shim",i).length&&a.append('<span class="mce-shim"></span>')})}),e.addCommand("mceMedia",r),this.showDialog=r});